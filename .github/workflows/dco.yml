# =====================================================================
#  HobbyCAD — .github/workflows/dco.yml — Developer Certificate of Origin check
# =====================================================================
#
#  Verifies that every commit in a pull request has a
#  Signed-off-by trailer, as required by the project's DCO policy.
#  See docs/coding_standards.txt §6.4 and https://developercertificate.org/
#
#  SPDX-License-Identifier: GPL-3.0-only
#
# =====================================================================

name: DCO

on:
  pull_request:
    branches: [ main ]

jobs:
  dco-check:
    name: Verify Signed-off-by
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check DCO sign-off
        run: |
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          failed=0

          for sha in $(git rev-list "$base".."$head"); do
            if ! git log -1 --format='%B' "$sha" | grep -qE '^Signed-off-by: .+ <.+>'; then
              echo "::error::Commit $sha is missing Signed-off-by trailer"
              git log -1 --format='  %h %s' "$sha"
              failed=1
            fi
          done

          if [ "$failed" -eq 1 ]; then
            echo ""
            echo "All commits must include a DCO sign-off."
            echo "Use: git commit -s"
            echo "To fix existing commits: git rebase --signoff HEAD~N"
            echo ""
            echo "See https://developercertificate.org/"
            exit 1
          fi

          echo "All commits have valid Signed-off-by trailers."
