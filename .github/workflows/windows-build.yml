# .github/workflows/windows-build.yml
#
# Build HobbyCAD on Windows using two toolchains:
#   - MSYS2 UCRT64 with GCC and pacman packages
#   - MSVC with vcpkg manifest mode
#
# The MSYS2 job matches the local developer setup from
# tools/windows/setup-env.ps1 (GCC, Ninja, pacman).
# The MSVC job tests MSVC/cl.exe compatibility using the
# pinned versions in vcpkg.json + vcpkg-configuration.json.
#
# First MSVC build is slow (~30 min) due to Qt6/OCCT
# compilation.  Subsequent builds use GitHub Actions cache
# via vcpkg binary caching, reducing install to ~2 min.
# MSYS2 builds use pre-built pacman packages (fast).

name: Windows Build

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'AUTHORS'
      - 'LICENSE'
      - '*.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'AUTHORS'
      - 'LICENSE'
      - '*.md'
  workflow_dispatch:

jobs:

  # ================================================================
  #  MSYS2 / UCRT64 / GCC
  # ================================================================
  #
  #  Matches the local developer environment.  All dependencies
  #  come from MSYS2 pacman (pre-built, fast).

  msys2:
    name: HobbyCAD via MSYS
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Disable autocrlf
        run: git config --global core.autocrlf input
        shell: bash

      - name: Checkout HobbyCAD
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-opencascade
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-svg
            mingw-w64-ucrt-x86_64-libzip
            mingw-w64-ucrt-x86_64-libpng
            mingw-w64-ucrt-x86_64-libjpeg-turbo
            mingw-w64-ucrt-x86_64-libgit2
            mingw-w64-ucrt-x86_64-ntldd

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build

      - name: Package build
        run: |
          cmake --install build --prefix build/install

          # Copy runtime DLLs from UCRT64
          BINDIR="build/install/bin"
          if [ -f "$BINDIR/hobbycad.exe" ]; then
              # Use ntldd to find DLL dependencies
              ntldd -R "$BINDIR/hobbycad.exe" 2>/dev/null | \
                  grep -i '/ucrt64/' | \
                  awk '{print $3}' | \
                  while read dll; do
                      cp -n "$dll" "$BINDIR/" 2>/dev/null || true
                  done

              # Qt plugins
              QT_PLUGIN_DIR="/ucrt64/share/qt6/plugins"
              if [ -d "$QT_PLUGIN_DIR/platforms" ]; then
                  mkdir -p "$BINDIR/platforms"
                  cp "$QT_PLUGIN_DIR/platforms/qwindows.dll" \
                      "$BINDIR/platforms/" 2>/dev/null || true
              fi
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hobbycad-windows-x64-msys2
          path: build/install/
          retention-days: 14
          if-no-files-found: error

  # ================================================================
  #  MSVC / vcpkg
  # ================================================================
  #
  #  Tests MSVC compatibility using the version-pinned
  #  dependencies declared in vcpkg.json.

  msvc:
    name: HobbyCAD via MSVC
    runs-on: windows-latest

    env:
      BUILD_TYPE: Release
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Checkout HobbyCAD
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        run: |
          # Use the pre-installed vcpkg on the runner, or clone fresh
          if (Test-Path "C:\vcpkg\vcpkg.exe") {
              Write-Host "Using pre-installed vcpkg at C:\vcpkg"
          } elseif (Test-Path "C:\vcpkg") {
              Write-Host "Bootstrapping existing C:\vcpkg..."
              & C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          } else {
              Write-Host "Cloning vcpkg..."
              git clone --depth 1 https://github.com/microsoft/vcpkg.git C:\vcpkg
              & C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          }
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "C:\vcpkg" >> $env:GITHUB_PATH

      - name: Setup MSVC developer environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install dependencies via vcpkg
        run: |
          vcpkg install --triplet x64-windows `
            --overlay-ports=${{ github.workspace }}/vcpkg-overlay-ports `
            --x-install-root=vcpkg_installed

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DVCPKG_INSTALLED_DIR=${{ github.workspace }}\vcpkg_installed

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package build
        shell: pwsh
        run: |
          $installDir = "build\install"
          cmake --install build --prefix $installDir

          # Copy Qt and OCCT runtime DLLs alongside the executable
          $binDir = "$installDir\bin"
          $vcpkgBin = "${{ github.workspace }}\vcpkg_installed\x64-windows\bin"

          # Qt plugins needed at runtime
          $qtPluginDir = "$installDir\bin\platforms"
          $vcpkgPlugins = "${{ github.workspace }}\vcpkg_installed\x64-windows\plugins"
          New-Item -ItemType Directory -Force -Path $qtPluginDir | Out-Null
          Copy-Item "$vcpkgPlugins\platforms\qwindows.dll" $qtPluginDir -ErrorAction SilentlyContinue

          # Copy all runtime DLLs the executable needs
          $exePath = Get-ChildItem "$binDir\hobbycad.exe" -ErrorAction SilentlyContinue
          if ($exePath) {
              $deps = & dumpbin /dependents $exePath.FullName 2>$null |
                      Select-String '\.dll' |
                      ForEach-Object { $_.ToString().Trim() }
              foreach ($dll in $deps) {
                  $src = Join-Path $vcpkgBin $dll
                  if (Test-Path $src) {
                      Copy-Item $src $binDir -ErrorAction SilentlyContinue
                  }
              }
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hobbycad-windows-x64-msvc
          path: build/install/
          retention-days: 14
          if-no-files-found: error
